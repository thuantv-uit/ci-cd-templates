name: Reusable CI Pipeline

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: false

    inputs:
      # -------- Environment --------
      language:
        type: string
        required: true

      version:
        type: string
        required: true

      workdir:
        type: string
        required: true

      # -------- Job Toggles --------
      enable_detect_job:
        type: boolean
        default: true

      enable_setup_job:
        type: boolean
        default: false

      enable_build_job:
        type: boolean
        default: false

      enable_sonar_job:
        type: boolean
        default: false

      enable_trivy_job:
        type: boolean
        default: false

      enable_jest_job:
        type: boolean
        default: false

      # -------- Detect change --------
      change_filters:
        type: string
        required: false

      # -------- Build / Test --------
      install_cmd:
        type: string
      build_cmd:
        type: string
      start_cmd:
        type: string
      test_cmd:
        type: string
      start_wait:
        type: number

      # -------- Sonar --------
      project_key:
        type: string
      organization:
        type: string
      extra_args:
        type: string

      # -------- Trivy --------
      trivy_image_name:
        type: string
      trivy_image_tag:
        type: string
        default: "latest"
      trivy_dockerfile:
        type: string
        default: "Dockerfile"
      trivy_severity:
        type: string
        default: "CRITICAL,HIGH"
      trivy_ignore_unfixed:
        type: boolean
        default: true
      trivy_exit_code:
        type: number
        default: 1

      # -------- Jest --------
      test_cmd_jest:
        type: string
        required: false
      start_db_cmd:
        type: string
        required: false
      close_db_cmd:
        type: string
        required: false
      

jobs:
  # --------------------------------------------------
  # 1. Detect source code changes
  # --------------------------------------------------
  detect-changes:
    if: inputs.enable_detect_job
    uses: ./.github/workflows/detect-change.yml
    with:
      change_filters: ${{ inputs.change_filters }}

  # --------------------------------------------------
  # 2. Setup runtime environment (Node, Python, Javaâ€¦)
  # --------------------------------------------------
  setup:
    needs: detect-changes
    if: |
      inputs.enable_setup_job && ( !inputs.enable_detect_job || needs.detect-changes.outputs.any_changed == 'true' )
    uses: ./.github/workflows/setup-environment.yml
    with:
      language: ${{ inputs.language }}
      version: ${{ inputs.version }}

  # --------------------------------------------------
  # 3. Build & Test application
  # --------------------------------------------------
  build:
    needs: setup
    if: inputs.enable_build_job
    uses: ./.github/workflows/build.yml
    with:
      language: ${{ inputs.language }}
      workdir: ${{ inputs.workdir }}

      install_cmd: ${{ inputs.install_cmd }}
      build_cmd: ${{ inputs.build_cmd }}
      start_cmd: ${{ inputs.start_cmd }}
      test_cmd: ${{ inputs.test_cmd }}
      start_wait: ${{ inputs.start_wait }}

  # --------------------------------------------------
  # 4. Static code analysis (SonarCloud)
  # --------------------------------------------------
  sonar:
    needs: build
    if: |
      inputs.enable_sonar_job &&
      inputs.project_key != '' &&
      ( !inputs.enable_detect_job || needs.detect-changes.outputs.any_changed == 'true' )
    uses: ./.github/workflows/sonarcloud-scan.yml
    with:
      project_key: ${{ inputs.project_key }}
      organization: ${{ inputs.organization }}
      workdir: ${{ inputs.workdir }}
      extra_args: ${{ inputs.extra_args }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # --------------------------------------------------
  # 5. Container Image Security Scan (Trivy)
  # --------------------------------------------------
  trivy-image:
    needs: build
    if: |
      inputs.enable_trivy_job &&
      inputs.trivy_image_name != '' &&
      ( !inputs.enable_detect_job || needs.detect-changes.outputs.any_changed == 'true' )
    uses: ./.github/workflows/trivy-scan.yml
    with:
      image_name: ${{ inputs.trivy_image_name }}
      image_tag: ${{ inputs.trivy_image_tag }}
      workdir: ${{ inputs.workdir }}
      dockerfile: ${{ inputs.trivy_dockerfile }}
      severity: ${{ inputs.trivy_severity }}
      ignore_unfixed: ${{ inputs.trivy_ignore_unfixed }}
      exit_code: ${{ inputs.trivy_exit_code }}

    # --------------------------------------------------
    # 6. Unit Test (Jest)
    # --------------------------------------------------
  jest-test:
    needs: build
    if: |
      inputs.enable_jest_job &&
      inputs.test_cmd_jest != '' &&
      ( !inputs.enable_detect_job || needs.detect-changes.outputs.any_changed == 'true' )
    uses: ./.github/workflows/jest-test.yml
    with:
      version: ${{ inputs.version }}
      workdir: ${{ inputs.workdir }}
      install_cmd: ${{ inputs.install_cmd }}
      test_cmd_jest: ${{ inputs.test_cmd_jest }}
      start_db_cmd: ${{ inputs.start_db_cmd }}
      close_db_cmd: ${{ inputs.close_db_cmd }}